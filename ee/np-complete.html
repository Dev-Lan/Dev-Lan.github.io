<!DOCTYPE html>
<html lang="en">
<head>
	<title>Dev-Lan</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="../style/darkly-bootstrap.min.css">
	<link rel="stylesheet" href="../style/devlan-style.css">
	<style type="text/css">
		html, body {margin:0;padding:10px;height:100%;width:100%;}

		.vis {
		  font: 10px sans-serif;
		  /*background-color: rgba(255,255,255,.6);*/
		  width: 100%;
		  height: 100%;

		  background: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MCIgaGVpZ2h0PSI5IiBmaWxsLW9wYWNpdHk9Ii44Ij4KPHJlY3Qgd2lkdGg9IjkwIiBoZWlnaHQ9IjkiIGZpbGw9IiNmMmYyZjIiPjwvcmVjdD4KPHJlY3Qgd2lkdGg9IjkwIiBoZWlnaHQ9IjIiIGZpbGw9IiNlN2U3ZTciPjwvcmVjdD4KPHJlY3QgeT0iMiIgd2lkdGg9IjkwIiBoZWlnaHQ9IjMiIGZpbGw9IiNlY2VjZWMiPjwvcmVjdD4KPC9zdmc+");

		}

		.bar.male {
			fill: url("#carbon-fiber-blue");
		}

		.bar.female {
			fill: url("#carbon-fiber-red");
		}

		.bar.male:hover {
			fill: url("#carbon-fiber-blue-hover");
		}

		.bar.female:hover {
			fill: url("#carbon-fiber-red-hover");
		}

		.bar:hover {
			fill-opacity: 0.75;
			stroke: black;
			stroke-width: 1px;
		}

		.axis text{
		  font: 12px sans-serif;
		  fill: #000;
		}

		.axis path,
		.axis line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		}

		.x.axis path {
		  display: none;
		}

		.header-text {
			font: 20px serif;
			font-weight: bold;
		}

	</style>
	<script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
	<!-- <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="http://www.google.com/jsapi"></script>
	<script type="text/javascript"> 
			google.load('visualization', '1', {packages: ['corechart']});
	</script>
	</head>
	<body>
	<svg class="vis">
		<defs>
		
		<pattern id="carbon-fiber-red" patternUnits="userSpaceOnUse" width="15" height="15"><image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNSI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzU5MjgyOCI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSIzIiBjeT0iNC4zIiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIzIiBjeT0iMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjEwLjUiIGN5PSIxMi41IiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIxMC41IiBjeT0iMTEuMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+Cjwvc3ZnPg==" x="0" y="0" width="15" height="15"></image></pattern>

		<pattern id="carbon-fiber-blue" patternUnits="userSpaceOnUse" width="15" height="15"><image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNSI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzI4Mjg1OSI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSIzIiBjeT0iNC4zIiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIzIiBjeT0iMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjEwLjUiIGN5PSIxMi41IiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIxMC41IiBjeT0iMTEuMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+Cjwvc3ZnPg==" x="0" y="0" width="15" height="15"></image></pattern>

		<pattern id="carbon-fiber-red-hover" patternUnits="userSpaceOnUse" width="20" height="20"><image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNSI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzU5MjgyOCI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSIzIiBjeT0iNC4zIiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIzIiBjeT0iMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjEwLjUiIGN5PSIxMi41IiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIxMC41IiBjeT0iMTEuMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+Cjwvc3ZnPg==" x="0" y="0" width="20" height="20"></image></pattern>

		<pattern id="carbon-fiber-blue-hover" patternUnits="userSpaceOnUse" width="20" height="20"><image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNSI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzI4Mjg1OSI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSIzIiBjeT0iNC4zIiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIzIiBjeT0iMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjEwLjUiIGN5PSIxMi41IiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIxMC41IiBjeT0iMTEuMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+Cjwvc3ZnPg==" x="0" y="0" width="20" height="20"></image></pattern>
		</defs>
	</svg>
	<script>
// LOAD DATA FROM GOOGLE SHEETS
	// references
	// https://developers.google.com/chart/interactive/docs/reference
	// https://gist.github.com/mhawksey/739602
		var spreadsheetID = "1DJY9sjmJE-2fBwKvjXIEo48I04-z7CqpmM5s2ElqTAs"
		var url = 'http://spreadsheets.google.com/tq?key=' + spreadsheetID + '&pub=1'
		var query = new google.visualization.Query(url);
		query.setQuery('SELECT B, C, D, E OFFSET 10');
		query.send(handleSelectResponse);
		var jsonObj;
		var allData = [];
		var maleBinned    = [0,0,0,0,0,0,0,0,0];
		var femaleBinned  = [0,0,0,0,0,0,0,0,0];
		var groupedNamesMale   = [[],[],[],[],[],[],[],[],[]];
		var groupedNamesFemale = [[],[],[],[],[],[],[],[],[]];
		var headers = ["SQUIB", "MUGGLE", "FLASHLIGHT", "LASER", "ELECTROMAGNET", "REESES", "SPIDERMAN", "CHARGER", "WIFI"];
		var maxInOneBin = 0;
		var maxFrequency = 0.0;
		var maleTotal = 0;
		var femaleTotal = 0;

		function handleSelectResponse(response) {
			if (response.isError()) {
				console.log('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
				return;
			}
			var jsonText = response.getDataTable().toJSON();
			jsonObj = JSON.parse(jsonText);

			for (var i = 0; i < jsonObj.rows.length; i++) {
				surveyResult = {lastName:jsonObj.rows[i].c[0]['v'] , firstName:jsonObj.rows[i].c[1]['v'] , npScore:jsonObj.rows[i].c[2]['v'] , gender:jsonObj.rows[i].c[3]['v'] };
				allData.push(surveyResult);
				if (surveyResult.gender == "f") {
					groupedNamesFemale[ surveyResult.npScore + 1].push(surveyResult.firstName+" "+surveyResult.lastName);
					femaleBinned[ surveyResult.npScore + 1 ]++;
					femaleTotal++;
				} else {
					groupedNamesMale[ surveyResult.npScore + 1].push(surveyResult.firstName+" "+surveyResult.lastName);
					maleBinned[ surveyResult.npScore + 1]++;
					maleTotal++;
				}
			}
			maxInOneBin = d3.max(maleBinned) > d3.max(femaleBinned) ? d3.max(maleBinned) : d3.max(femaleBinned);
			maxFrequency = d3.max(maleBinned) / maleTotal > d3.max(femaleBinned) / femaleTotal ? d3.max(maleBinned) / maleTotal: d3.max(femaleBinned) / femaleTotal;
			createVisual();
		}

var nameBox,
	visNode,
	height,
	nameBoxWidth,
	nameBoxHeader;

// var data = d3.range(1000).map(d3.randomBates(10));
function createVisual() {

	visNode = d3.select(".vis");

	var margin = {top: 20, right: 40, bottom: 30, left: 40};
	nameBoxWidth = 180;
	var width = visNode.node().getBoundingClientRect().width - margin.left - 2*margin.right - nameBoxWidth;
	height = visNode.node().getBoundingClientRect().height - margin.top - margin.bottom;

	nameBox = visNode.append("g")
		.attr("transform", "translate(" + (margin.left + width + margin.right) + ","+margin.top+")")
		.attr("class", "name-box");

	nameBoxHeader = nameBox.append("g");
	nameBoxHeader.append("text")
		.text("ABILITY")
		.attr("class", "header-text");

	var topNode = visNode.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var yScaleMale = d3.scaleLinear()
		.domain([0, maxFrequency ])
		.range([0, height]);

	var yScaleFemale = d3.scaleLinear()
		.domain([0, maxFrequency ])
		.range([0, height]);

	var topWidth = width;
	var numBins = maleBinned.length;

	var barWidth = topWidth / numBins;
	var barHeight = height;

// AXIS
	var y = d3.scaleLinear()
		.domain([0, maxFrequency ])
		.range([barHeight, 0]);

	var yAxis = d3.axisLeft(y)
		.ticks(10, "%");

	topNode.append("g")
		.attr("class", "y axis")
		.call(yAxis)
	.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.text("Frequency");

	var x = d3.scaleBand()
		.domain([-1,0,1,2,3,4,5,6,7])
		.range([0,width]);

	var xAxis = d3.axisBottom(x);

	topNode.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0,"+height+")")
		.call(xAxis);

// CONSTRUCT BARS

	var maleBars = topNode.append("g");

	var bar1 = maleBars.selectAll("rect")
		.data(maleBinned)
		.enter().append("rect")
		.attr("class", "bar male")
		.attr("x", function(d,i) { return i * barWidth + 4; } )
		.attr("y", function(d,i) { return barHeight - yScaleMale(d / maleTotal)})
		.attr("width", function(d) { return (barWidth / 2.0) - 5 })
		.attr("height", function(d) { return yScaleMale(d / maleTotal); })
		.attr("onclick", function(d,i) { return "switchNames("+i+",false)"; });

	var femaleBars = topNode.append("g");

	var bar2 = femaleBars.selectAll("rect")
		.data(femaleBinned)
		.enter().append("rect")
		.attr("class", "bar female")
		.attr("x", function(d,i) { return i * barWidth + barWidth/2.0; } )
		.attr("y", function(d,i) { return barHeight - yScaleFemale(d / femaleTotal)})
		.attr("width", function(d) { return (barWidth / 2.0) - 5 })
		.attr("height", function(d) { return yScaleFemale(d / femaleTotal); })
		.attr("onclick", function(d,i) { return "switchNames("+i+",true)"; });
}

var nameHeight = 12;
var nameOffset = 20;
function switchNames(index, genderFemale) {
	if (genderFemale) {
		nameBoxHeader.selectAll("text")
			.text(headers[index] +"-"+ femaleBinned[index])
			.attr("class", "header-text");
		var text = nameBox.selectAll("text.name");

		text = text.data(groupedNamesFemale[index])
			.text(function(d) { return d; })
			.attr("y", function(d,i) {return nameHeight * i + nameOffset;});

		text.enter().append("text")
			.attr("class", "name")
			.attr("y", function(d,i) {return nameHeight * i + nameOffset;})
			.text(function(d) { return d; });

		nameBox.selectAll("text.name")
			.style("fill", "green")
			.style("fill-opacity", "0")
			.attr("x",  function() { return (d3.randomUniform(50, 500)()); } )
		.transition()
			.duration(1300)
			.attr("x", 0)
			.style("fill", "black")
			.style("fill-opacity", "1");

		text.exit().remove();
	} else {
		nameBoxHeader.selectAll("text")
			.text(headers[index] +"-"+ maleBinned[index])
			.attr("class", "header-text");
		
		var text = nameBox.selectAll("text.name");

		text = text.data(groupedNamesMale[index])
			.text(function(d) { return d; })
			.attr("y", function(d,i) {return nameHeight * i + nameOffset;});

		text.enter().append("text")
			.attr("class", "name")
			.attr("y", function(d,i) {return nameHeight * i + nameOffset;})
			.text(function(d) { return d; });

		nameBox.selectAll("text.name")
			.style("fill", "green")
			.style("fill-opacity", "0")
			.attr("x",  function() { return (d3.randomUniform(50, 500)()); } )
		.transition()
			.duration(1300)
			.attr("x", 0)
			.style("fill", "black")
			.style("fill-opacity", "1");

		text.exit().remove();
	}
	return;
}

var last = 0;
var timeElapsed = 0;
d3.timer(function(elapsed) {
  timeElapsed = elapsed / 100 ;
  update();
});

function update() {
	var text = nameBox.selectAll("text.name");
	var numNames = text.size();
	if (numNames * nameHeight > height) {
		text.attr("y", function(d,i) { return (nameHeight * i + timeElapsed) % (numNames * nameHeight) + nameOffset; })
	}
}
	</script>

</body>
</html>
